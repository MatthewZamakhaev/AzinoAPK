name: Build APK

on:
  workflow_dispatch:
    inputs:
      campaign:
        description: "Campaign name"
        required: false
        default: "default_campaign"
      user_id:
        description: "Unique user ID"
        required: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ› ï¸ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ“¦ Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ðŸ—ï¸ Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: ðŸ“¥ Install dependencies
        run: |
          ./gradlew dependencies || echo "Warning: Dependencies not fully resolved"

      - name: ðŸ”§ Generate config.json
        run: |
          mkdir -p app/src/main/assets/
          echo '{"campaign": "${{ github.event.inputs.campaign }}"}' > app/src/main/assets/config.json
          cat app/src/main/assets/config.json

      - name: ðŸ› ï¸ Grant execute permission to gradlew
        run: chmod +x gradlew

      - name: ðŸ§¹ Clean project
        run: ./gradlew clean

      - name: ðŸ”¨ Build APK
        run: ./gradlew assembleDebug

      - name: ðŸ”‘ Decode and Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "LS0tLS1CRUdJTiBPUEVOU1NIIFBSSVZBVEUgS0VZLS0tLS0KYjNCbGJuTnphQzFyWlhrdGRqRUFB
QUFBQkc1dmJtVUFBQUFFYm05dVpRQUFBQUFBQUFBQkFBQUNGd0FBQUFkemMyZ3RjbgpOaEFBQUFB
d0VBQVFBQUFnRUFxcWJyT0RXZXFaNnR5WkZEOUp5N3FLMlVkeHE3cnpIY003ZVpNZ1RIY2N0blpu
c3lnSFRCClU0aGFVNWh1QTZIYTUyT1VaR00yVVp2Y0RlUGdCY29MYzZpenZVTW9zSElDeVBKRkVx
RkVrdkFPQmV4enkrczdBWUZnV2kKdWpIaGQwa2RhNGRobkhNemNpR1FlRUN3VHBURnRCRmZ2ZTg3
ZlpMclE3ZkJPWm9QRDZ0ZTJ4RUxaNDRIaE4vNW11SHhleQpYNzVRZ2orcEpTMG5tTDlSS0dvbisy
SmdoMjNhS1RCMkdLSlhYbXpyRmhPZ1FWR21LSTE2emxmUGdBa083cDdEQ0t2VE9NCkdaY2RaL2Vt
MGlUbW9NdEw4d0pIa0JBSklYZlE0Um1jWGxuSXdxNGtxNERyZ1JOODNpTlpETlFpRFUwNHJiL2t3
RS80SnUKcVlrU2FPTDFwV0lTdk5oMWZFMDlOSStWbENkWTI2ZGVBWjBiUE0yODlPdlI0Mlpkd2t0
SGZpcnljN3lTekhkeFZmcUxVUgoxWDZRbThEaHdsQ3J6cVlIbm9raEZaVlBhUWlqeGlKd3IyejR6
K0VQd1dncGROTFl6TWY1UUxyYVFmbmpyRHhwR3hEVUp5CndkZWZ3SldwbWlxZWM4TFcyaHoyMUdj
cGdjYmlYcFBkYWVkMkhvMkw2VDV5WlNFNmpxeTVnNHp4SHNZTFgwZURxblFIclAKR2tndzNoNk4w
bEp5dThVVDBQK0l1a2VTWnNCRHJ5SDBvVmh3QTA3bHJCNzlUUFBxVlNLbXdHTnN4VGhWYnBoSzRn
bXJnSgpBbGhTZXM3OW5WZ2NHWElhWHAxSXdjNmtWUE5sTDVyQ0dXMkUrOW9xdlBINEZ0ODcxa05P
dFIzbkZ4b0tlNndicjY3bjFOCk1BQUFkSUJROEl0UVVQQ0xVQUFBQUhjM05vTFhKellRQUFBZ0VB
cXFick9EV2VxWjZ0eVpGRDlKeTdxSzJVZHhxN3J6SGMKTTdlWk1nVEhjY3RuWm5zeWdIVEJVNGhh
VTVodUE2SGE1Mk9VWkdNMlVadmNEZVBnQmNvTGM2aXp2VU1vc0hJQ3lQSkZFcQpGRWt2QU9CZXh6
eStzN0FZRmdXaXVqSGhkMGtkYTRkaG5ITXpjaUdRZUVDd1RwVEZ0QkZmdmU4N2ZaTHJRN2ZCT1pv
UEQ2CnRlMnhFTFo0NEhoTi81bXVIeGV5WDc1UWdqK3BKUzBubUw5UktHb24rMkpnaDIzYUtUQjJH
S0pYWG16ckZoT2dRVkdtS0kKMTZ6bGZQZ0FrTzdwN0RDS3ZUT01HWmNkWi9lbTBpVG1vTXRMOHdK
SGtCQUpJWGZRNFJtY1hsbkl3cTRrcTREcmdSTjgzaQpOWkROUWlEVTA0cmIva3dFLzRKdXFZa1Nh
T0wxcFdJU3ZOaDFmRTA5TkkrVmxDZFkyNmRlQVowYlBNMjg5T3ZSNDJaZHdrCnRIZmlyeWM3eVN6
SGR4VmZxTFVSMVg2UW04RGh3bENyenFZSG5va2hGWlZQYVFpanhpSndyMno0eitFUHdXZ3BkTkxZ
ek0KZjVRTHJhUWZuanJEeHBHeERVSnl3ZGVmd0pXcG1pcWVjOExXMmh6MjFHY3BnY2JpWHBQZGFl
ZDJIbzJMNlQ1eVpTRTZqcQp5NWc0enhIc1lMWDBlRHFuUUhyUEdrZ3czaDZOMGxKeXU4VVQwUCtJ
dWtlU1pzQkRyeUgwb1Zod0EwN2xyQjc5VFBQcVZTCkttd0dOc3hUaFZicGhLNGdtcmdKQWxoU2Vz
NzluVmdjR1hJYVhwMUl3YzZrVlBObEw1ckNHVzJFKzlvcXZQSDRGdDg3MWsKTk90UjNuRnhvS2U2
d2JyNjduMU5NQUFBQURBUUFCQUFBQ0FBbkpvcjBVYWpkaW9xZG9jd1FyeHlHYlpHUUR2d0d0M2or
RApITUMvS3hkRGxNM09iQmVYc0F6cFNhWk9IRS9qV25STXJ2MVEvcjVsMk9teVhsakdxQUI5WVEy
NUNvamxpUjViQ0RZbzFMCm8wRllIUkl0VVpJVWNWVTJBOTdOQkpoUnM3a2FuZHZFeWJocjVMd3VR
dmtjS2FOZkh4QW01cVp0cFBFUWhYOFhHY2UxZGEKNTMzRXZDQnRGZ0FwSVh1bXRzbUNBZ2taRUtE
OEVDOS93dTVmK2FTK2xZMis4YlVpRXBhWUhRMjM0OXN6ZGZkanhrckF6cApYWXpjMjk5MExJRFU5
SkxQSURrZTJkdHEyMVpsM1JVYUxvN1BYSDVqNzdvaExwN3lncGhHRmJDQXlobE12c3A3bDlKVkp3
CkxkaEluTWI0bnc4eDcxUWVUWUxneEpNS2VBOCticVJBYWF3SFRIUkZVT0dLNllxNkNkd3cvKzNa
VnFETzVtNHdBTlZNUWsKV3d1bCtibGJIelNIUnFEZzVFVE9hdHdlVTRoWG4vdk9yM3VFNUxzUUJZ
ZTdrUDJYQ1Z2bnVNcGVMZE4zTWJhMzZFWUFlQwpNLzRRd0JMZDRmOFFWUFlSRzZESXZIRUdyR2s5
RU11eDE5MzA0RXZaMzhUUHJDTmlLcUtzZ0RybmlKY2hTTEVZRjlKNkdVCkd0ODFZUE9CaS9aaS9H
QkIzeEFON094RnpWVWNoZGVLUjBkQWlvTmxwS0xNT3RrU1NGUzVrSXhNQWJXVndxeEh5UjQyWXAK
Y2g0MitZZGpYZDZnMC85OVowSDdaTXgzVVNaK0V3OTJxRFZKRFZZWXdxZHlUdUl4N0cxdHYwQzV5
MCsvRmhxcUdCVld4YwphS3BzcW4yVTFEdnEvYWVDMXBBQUFCQUFxRnRmbnpRNisvaVZJbFEvRlJX
aUlPNWdQQmk2RFJTR0k3eitRUUlRa29FTFBOCkdpQ2pHU3FXbXhuOFN0Wk15cFAxTGdRQUh0dTc0
NU1SME5ZWDhGaEhVSDNZMVhTRGE2V2kzaTF3RWZjc0JqWUJ3UGwyeUIKbjFoSm9iMDJ4SkNzRHhr
cVBBRHBramUzVGFtcUdkZ3JIMGVZVlI4cG80czFBRklZaHV6eW1ESG40djJXOWlUN1ZoMFBnOApu
bnVUTWl0Z0ZDcGZxTWtNTGFtUFpFV3h4bE9QVGtvVEZvNWVYa3ZvSW82SEFWQnVyV09PMit5cVBO
UnE5SHJZTCt3Q0hsClI4a0lTeVFjeUtvb0hoQ2tUYXUxVGtFTWpvZXRKR290UFQ1WlNjU2JNd21k
QmVKRVp2bjMxRjlRb1ZXOWVtWjI5OWR2enoKTVJpVVJUN1dDMmU3a21rQUFBRUJBTXRBaldFOUFq
dktTb3J4QitGaThyRytScW0rdHZxQWxnUURkcThsSVIvYWZIRjM1WQpyVlUyTUM0c3lBOVoxOXpU
cXlIQ0lYK1FNZ0hDeFZaZ3lnbWZmekhPVit0V3QxRWRPdWhudjFKN0kvaVJLYWN3Q0VGQzZGClly
SVFabCthT3RIOFZWb2ZXQlU1cmxDTStHK3FwL2dSV3lRZXdvMUhQcThFRHRaMFZSVGVmU0lUakl5
NVpoM2poQ1F3TG8KQWljZXF0OUpTdHBUK1hucFI1cmx1OGdpNHpyazBKTloyQmUxNDV6emNrK1px
MnhDcG8vcjdRcEc0YmlvUjdkVk9ZWHNUdQpydm5reURoRlRnYVd5ZnZjVkd0UXp4dnFWcEFhcHE5
TDNpNHQ1cGRQeTRCT2QwaUJLUk4zRDRpY1gxUHFSR09qcVVLMUprCkJTaTUySHErYkw5MHNBQUFF
QkFOYndnNlF0Q2ZxSVJhWGxpdEsxTFVtSlNQTkkvSSsrZlRNUjkvOWJERkV5Z2NhTkFDOHQKUjBB
UFdVeC9VYjlReVFEak40cW1YUmZvUU93aFdxQkJpc0R6a1N0eXFoVDhSejZDR1FSazJWZkZkeXhC
a0FSUVJIM2VMdQpvaTBBUGRzdnNhTG1YZ1JjaExKbUVlNFlVcmRka040UmJ2WGZOYm1iRktsUFYw
Qk5wNmROTmNoQmo4KzI1K0JRQ2tENU5UCkhsSG9nZUhiT3dGZmRpSCtGdWhYN0ZaSmVSUnVFak5T
RTBkdEhoNjBSV2R4SUplcytwUXVRb2IvSHFIYlV1aDhaWFRlazAKTmI0OG9rRDVBcnR4NklxV1Vx
V1lmNFp1RVJXYjVpZUlqVjIwYUhOU3NtN3VDSWVUT3hKNW5oL25tR3FjY0hVZm9BZHFLMgoyZ1Y2
V3MrUWU1a0FBQUFPWjJsMGFIVmlMV0ZqZEdsdmJuTUJBZ01FQlE9PQotLS0tLUVORCBPUEVOU1NI
IFBSSVZBVEUgS0VZLS0tLS0K" | base64 --decode > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan serverapk11.fun >> ~/.ssh/known_hosts

      - name: ðŸ“¤ Upload APK to server
        run: |
          echo "Uploading APK to server..."
          scp -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa \
            app/build/outputs/apk/debug/app-debug.apk \
            root@serverapk11.fun:/tmp/apk_builds/${{ github.event.inputs.user_id }}.apk
