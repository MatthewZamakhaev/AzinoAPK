name: Build APK

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: üõ†Ô∏è –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
        uses: actions/checkout@v4

      - name: üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: üèóÔ∏è –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º SDK Android
        uses: android-actions/setup-android@v3

      - name: üì• –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
        run: ./gradlew dependencies || true

      - name: üîß –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º config.json
        run: |
          mkdir -p app/src/main/assets/  # ‚úÖ –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
          echo '{"campaign": "default_campaign"}' > app/src/main/assets/config.json
          cat app/src/main/assets/config.json

      - name: üî® –°–±–æ—Ä–∫–∞ APK
        run: ./gradlew assembleDebug

      - name: üì§ –ó–∞–≥—Ä—É–∂–∞–µ–º APK –≤ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
        uses: actions/upload-artifact@v4  # ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è
        with:
          name: app-debug
          path: app/build/outputs/apk/debug/app-debug.apk

      - name: üöÄ –ó–∞–≥—Ä—É–∂–∞–µ–º APK –≤ Releases (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        if: startsWith(github.ref, 'refs/heads/main')
        uses: ncipollo/release-action@v1
        with:
          artifacts: app/build/outputs/apk/debug/app-debug.apk
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: latest
          name: "Latest APK"
          body: "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–±—Ä–∞–Ω–Ω—ã–π APK"
