name: Build APK

on:
  workflow_dispatch:
    inputs:
      campaign:
        description: "Campaign name"
        required: false
        default: "default_campaign"
      user_id:
        description: "Unique user ID"
        required: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: 🛠️ Checkout repository
        uses: actions/checkout@v4

      - name: 📦 Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: 🏗️ Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: 📥 Install dependencies
        run: |
          ./gradlew dependencies || echo "Warning: Dependencies not fully resolved"

      - name: 🔧 Generate config.json
        run: |
          mkdir -p app/src/main/assets/
          echo '{"campaign": "${{ github.event.inputs.campaign }}"}' > app/src/main/assets/config.json
          cat app/src/main/assets/config.json

      - name: 🛠️ Grant execute permission to gradlew
        run: chmod +x gradlew

      - name: 🧹 Clean project
        run: ./gradlew clean

      - name: 🔨 Build APK
        run: ./gradlew assembleDebug

      - name: 🔑 Decode and Setup SSH key
        run: |
          mkdir -p ~/.ssh
          printf "%s" "LS0tLS1CRUdJTiBPUEVOU1NIIFBSSVZBVEUgS0VZLS0tLS0KYjNCbGJuTnphQzFyWlhrdGRqRUFBQUFBQkc1dmJtVUFBQUFFYm05dVpRQUFBQUFBQUFBQkFBQUNGd0FBQUFkemMyZ3RjbgpOaEFBQUFBd0VBQVFBQUFnRUFxcWJyT0RXZXFaNnR5WkZEOUp5N3FLMlVkeHE3cnpIY003ZVpNZ1RIY2N0blpuc3lnSFRCClU0aGFVNWh1QTZIYTUyT1VaR00yVVp2Y0RlUGdCY29MYzZpenZVTW9zSElDeVBKRkVxRkVrdkFPQmV4enkrczdBWUZnV2kKdWpIaGQwa2RhNGRobkhNemNpR1FlRUN3VHBURnRCRmZ2ZTg3ZlpMclE3ZkJPWm9QRDZ0ZTJ4RUxaNDRIaE4vNW11SHhleQpYNzVRZ2orcEpTMG5tTDlSS0dvbisySmdoMjNhS1RCMkdLSlhYbXpyRmhPZ1FWR21LSTE2emxmUGdBa083cDdEQ0t2VE9NCkdaY2RaL2VtMGlUbW9NdEw4d0pIa0JBSklYZlE0Um1jWGxuSXdxNGtxNERyZ1JOODNpTlpETlFpRFUwNHJiL2t3RS80SnUKcVlrU2FPTDFwV0lTdk5oMWZFMDlOSStWbENkWTI2ZGVBWjBiUE0yODlPdlI0Mlpkd2t0SGZpcnljN3lTekhkeFZmcUxVUgoxWDZRbThEaHdsQ3J6cVlIbm9raEZaVlBhUWlqeGlKd3IyejR6K0VQd1dncGROTFl6TWY1UUxyYVFmbmpyRHhwR3hEVUp5CndkZWZ3SldwbWlxZWM4TFcyaHoyMUdjcGdjYmlYcFBkYWVkMkhvMkw2VDV5WlNFNmpxeTVnNHp4SHNZTFgwZURxblFIclAKR2tndzNoNk4wbEp5dThVVDBQK0l1a2VTWnNCRHJ5SDBvVmh3QTA3bHJCNzlUUFBxVlNLbXdHTnN4VGhWYnBoSzRnbXJnSgpBbGhTZXM3OW5WZ2NHWElhWHAxSXdjNmtWUE5sTDVyQ0dXMkUrOW9xdlBINEZ0ODcxa05PdFIzbkZ4b0tlNndicjY3bjFOCk1BQUFkSUJROEl0UVVQQ0xVQUFBQUhjM05vTFhKellRQUFBZ0VBcXFick9EV2VxWjZ0eVpGRDlKeTdxSzJVZHhxN3J6SGMKTTdlWk1nVEhjY3RuWm5zeWdIVEJVNGhhVTVodUE2SGE1Mk9VWkdNMlVadmNEZVBnQmNvTGM2aXp2VU1vc0hJQ3lQSkZFcQpGRWt2QU9CZXh6eStzN0FZRmdXaXVqSGhkMGtkYTRkaG5ITXpjaUdRZUVDd1RwVEZ0QkZmdmU4N2ZaTHJRN2ZCT1pvUEQ2CnRlMnhFTFo0NEhoTi81bXVIeGV5WDc1UWdqK3BKUzBubUw5UktHb24rMkpnaDIzYUtUQjJHS0pYWG16ckZoT2dRVkdtS0kKMTZ6bGZQZ0FrTzdwN0RDS3ZUT01HWmNkWi9lbTBpVG1vTXRMOHdKSGtCQUpJWGZRNFJtY1hsbkl3cTRrcTREcmdSTjgzaQpOWkROUWlEVTA0cmIva3dFLzRKdXFZa1NhT0wxcFdJU3ZOaDFmRTA5TkkrVmxDZFkyNmRlQVowYlBNMjg5T3ZSNDJaZHdrCnRIZmlyeWM3eVN6SGR4VmZxTFVSMVg2UW04RGh3bENyenFZSG5va2hGWlZQYVFpanhpSndyMno0eitFUHdXZ3BkTkxZek0KZjVRTHJhUWZuanJEeHBHeERVSnl3ZGVmd0pXcG1pcWVjOExXMmh6MjFHY3BnY2JpWHBQZGFlZDJIbzJMNlQ1eVpTRTZqcQp5NWc0enhIc1lMWDBlRHFuUUhyUEdrZ3czaDZOMGxKeXU4VVQwUCtJdWtlU1pzQkRyeUgwb1Zod0EwN2xyQjc5VFBQcVZTCkttd0dOc3hUaFZicGhLNGdtcmdKQWxoU2VzNzluVmdjR1hJYVhwMUl3YzZrVlBObEw1ckNHVzJFKzlvcXZQSDRGdDg3MWsKTk90UjNuRnhvS2U2d2JyNjduMU5NQUFBQURBUUFCQUFBQ0FBbkpvcjBVYWpkaW9xZG9jd1FyeHlHYlpHUUR2d0d0M2orRApITUMvS3hkRGxNM09iQmVYc0F6cFNhWk9IRS9qV25STXJ2MVEvcjVsMk9teVhsakdxQUI5WVEyNUNvamxpUjViQ0RZbzFMCm8wRllIUkl0VVpJVWNWVTJBOTdOQkpoUnM3a2FuZHZFeWJocjVMd3VRdmtjS2FOZkh4QW01cVp0cFBFUWhYOFhHY2UxZGEKNTMzRXZDQnRGZ0FwSVh1bXRzbUNBZ2taRUtEOEVDOS93dTVmK2FTK2xZMis4YlVpRXBhWUhRMjM0OXN6ZGZkanhrckF6cApYWXpjMjk5MExJRFU5SkxQSURrZTJkdHEyMVpsM1JVYUxvN1BYSDVqNzdvaExwN3lncGhHRmJDQXlobE12c3A3bDlKVkp3CkxkaEluTWI0bnc4eDcxUWVUWUxneEpNS2VBOCticVJBYWF3SFRIUkZVT0dLNllxNkNkd3cvKzNaVnFETzVtNHdBTlZNUWsKV3d1bCtibGJIelNIUnFEZzVFVE9hdHdlVTRoWG4vdk9yM3VFNUxzUUJZZTdrUDJYQ1Z2bnVNcGVMZE4zTWJhMzZFWUFlQwpNLzRRd0JMZDRmOFFWUFlSRzZESXZIRUdyR2s5RU11eDE5MzA0RXZaMzhUUHJDTmlLcUtzZ0RybmlKY2hTTEVZRjlKNkdVCkd0ODFZUE9CaS9aaS9HQkIzeEFON094RnpWVWNoZGVLUjBkQWlvTmxwS0xNT3RrU1NGUzVrSXhNQWJXVndxeEh5UjQyWXAKY2g0MitZZGpYZDZnMC85OVowSDdaTXgzVVNaK0V3OTJxRFZKRFZZWXdxZHlUdUl4N0cxdHYwQzV5MCsvRmhxcUdCVld4YwphS3BzcW4yVTFEdnEvYWVDMXBBQUFCQUFxRnRmbnpRNisvaVZJbFEvRlJXaUlPNWdQQmk2RFJTR0k3eitRUUlRa29FTFBOCkdpQ2pHU3FXbXhuOFN0Wk15cFAxTGdRQUh0dTc0NU1SME5ZWDhGaEhVSDNZMVhTRGE2V2kzaTF3RWZjc0JqWUJ3UGwyeUIKbjFoSm9iMDJ4SkNzRHhrcVBBRHBramUzVGFtcUdkZ3JIMGVZVlI4cG80czFBRklZaHV6eW1ESG40djJXOWlUN1ZoMFBnOApubnVUTWl0Z0ZDcGZxTWtNTGFtUFpFV3h4bE9QVGtvVEZvNWVYa3ZvSW82SEFWQnVyV09PMit5cVBOUnE5SHJZTCt3Q0hsClI4a0lTeVFjeUtvb0hoQ2tUYXUxVGtFTWpvZXRKR290UFQ1WlNjU2JNd21kQmVKRVp2bjMxRjlRb1ZXOWVtWjI5OWR2enoKTVJpVVJUN1dDMmU3a21rQUFBRUJBTXRBaldFOUFqdktTb3J4QitGaThyRytScW0rdHZxQWxnUURkcThsSVIvYWZIRjM1WQpyVlUyTUM0c3lBOVoxOXpUcXlIQ0lYK1FNZ0hDeFZaZ3lnbWZmekhPVit0V3QxRWRPdWhudjFKN0kvaVJLYWN3Q0VGQzZGCllySVFabCthT3RIOFZWb2ZXQlU1cmxDTStHK3FwL2dSV3lRZXdvMUhQcThFRHRaMFZSVGVmU0lUakl5NVpoM2poQ1F3TG8KQWljZXF0OUpTdHBUK1hucFI1cmx1OGdpNHpyazBKTloyQmUxNDV6emNrK1pxMnhDcG8vcjdRcEc0YmlvUjdkVk9ZWHNUdQpydm5reURoRlRnYVd5ZnZjVkd0UXp4dnFWcEFhcHE5TDNpNHQ1cGRQeTRCT2QwaUJLUk4zRDRpY1gxUHFSR09qcVVLMUprCkJTaTUySHErYkw5MHNBQUFFQkFOYndnNlF0Q2ZxSVJhWGxpdEsxTFVtSlNQTkkvSSsrZlRNUjkvOWJERkV5Z2NhTkFDOHQKUjBBUFdVeC9VYjlReVFEak40cW1YUmZvUU93aFdxQkJpc0R6a1N0eXFoVDhSejZDR1FSazJWZkZkeXhCa0FSUVJIM2VMdQpvaTBBUGRzdnNhTG1YZ1JjaExKbUVlNFlVcmRka040UmJ2WGZOYm1iRktsUFYwQk5wNmROTmNoQmo4KzI1K0JRQ2tENU5UCkhsSG9nZUhiT3dGZmRpSCtGdWhYN0ZaSmVSUnVFak5TRTBkdEhoNjBSV2R4SUplcytwUXVRb2IvSHFIYlV1aDhaWFRlazAKTmI0OG9rRDVBcnR4NklxV1VxV1lmNFp1RVJXYjVpZUlqVjIwYUhOU3NtN3VDSWVUT3hKNW5oL25tR3FjY0hVZm9BZHFLMgoyZ1Y2V3MrUWU1a0FBQUFPWjJsMGFIVmlMV0ZqZEdsdmJuTUJBZ01FQlE9PQotLS0tLUVORCBPUEVOU1NIIFBSSVZBVEUgS0VZLS0tLS0K" | base64 --decode > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan serverapk11.fun >> ~/.ssh/known_hosts

      - name: 📤 Upload APK to server
        run: |
          echo "Uploading APK to server..."
          scp -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa \
            app/build/outputs/apk/debug/app-debug.apk \
            root@serverapk11.fun:/tmp/apk_builds/${{ github.event.inputs.user_id }}.apk
